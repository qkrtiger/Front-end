<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ÏãúÎ†• Í≤ÄÏÇ¨ ÎèÑÍµ¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/opencv.js/4.5.5/opencv.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            color: #7f8c8d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .test-area {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.3em;
        }

        .video-container {
            position: relative;
            margin-bottom: 20px;
        }

        #webcam {
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            border: 3px solid #3498db;
        }

        .distance-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .eye-chart {
            background: white;
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #ecf0f1;
            margin: 20px 0;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-line {
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 3px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .test-progress {
            background: #ecf0f1;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }

        .results {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
        }

        .calibration {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .instructions {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
        }

        .instructions h4 {
            color: #27ae60;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }

        .hidden {
            display: none;
        }

        .chart-letters {
            font-size: 60px;
            line-height: 1.2;
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 10px;
        }

        .current-test {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .face-detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üëÅÔ∏è AI ÏãúÎ†• Í≤ÄÏÇ¨ ÎèÑÍµ¨</h1>
            <p>ÏõπÏ∫†Í≥º AIÎ•º ÌôúÏö©Ìïú ÏûêÍ∞Ä ÏãúÎ†• Í≤ÄÏÇ¨ ÏãúÏä§ÌÖú</p>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <div class="section">
                    <h3>üìπ ÏõπÏ∫† ÏÑ§Ï†ï</h3>
                    <div class="video-container">
                        <video id="webcam" autoplay muted></video>
                        <canvas id="overlay" class="face-detection-overlay"></canvas>
                    </div>
                    <button id="startWebcam" class="btn">ÏõπÏ∫† ÏãúÏûë</button>
                    <button id="stopWebcam" class="btn btn-danger">ÏõπÏ∫† Ï§ëÏßÄ</button>
                    <div class="distance-info">
                        <strong>Ï∏°Ï†ïÎêú Í±∞Î¶¨:</strong> <span id="distanceDisplay">Ï∏°Ï†ï Ï§ë...</span><br>
                        <strong>Í∂åÏû• Í±∞Î¶¨:</strong> 60cm
                    </div>
                </div>

                <div class="section">
                    <h3>‚öôÔ∏è Í≤ÄÏÇ¨ ÏÑ§Ï†ï</h3>
                    <div class="input-group">
                        <label for="testEye">Í≤ÄÏÇ¨Ìï† Îàà:</label>
                        <select id="testEye">
                            <option value="both">ÏñëÏ™Ω Îàà</option>
                            <option value="left">ÏôºÏ™Ω Îàà</option>
                            <option value="right">Ïò§Î•∏Ï™Ω Îàà</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="screenSize">Î™®ÎãàÌÑ∞ ÌÅ¨Í∏∞ (Ïù∏Ïπò):</label>
                        <input type="number" id="screenSize" value="24" min="10" max="50" step="0.1">
                    </div>
                    <div class="input-group">
                        <label for="testDistance">Í≤ÄÏÇ¨ Í±∞Î¶¨ (cm):</label>
                        <input type="number" id="testDistance" value="60" min="30" max="100" step="5">
                    </div>
                </div>

                <div class="section">
                    <h3>üéØ Í≤ÄÏÇ¨ Ï†úÏñ¥</h3>
                    <button id="calibrateBtn" class="btn">Í±∞Î¶¨ Î≥¥Ï†ï</button>
                    <button id="startTestBtn" class="btn btn-success" disabled>Í≤ÄÏÇ¨ ÏãúÏûë</button>
                    <button id="resetBtn" class="btn btn-danger">Ï¥àÍ∏∞Ìôî</button>
                    
                    <div class="test-progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div id="testStatus" class="status info">ÏõπÏ∫†ÏùÑ ÏãúÏûëÌïòÍ≥† Í±∞Î¶¨Î•º Î≥¥Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.</div>
                </div>
            </div>

            <div class="test-area">
                <div class="instructions">
                    <h4>üìã Í≤ÄÏÇ¨ Î∞©Î≤ï</h4>
                    <ol>
                        <li>ÏõπÏ∫†ÏùÑ ÏãúÏûëÌïòÍ≥† ÌôîÎ©¥ÏóêÏÑú 60cm Í±∞Î¶¨Î•º Ïú†ÏßÄÌïòÏÑ∏Ïöî</li>
                        <li>ÌïúÏ™Ω ÎààÏùÑ Í∞ÄÎ¶¨Í≥† Í≤ÄÏÇ¨ÌïòÍ±∞ÎÇò ÏñëÏ™Ω ÎààÏúºÎ°ú Í≤ÄÏÇ¨ÌïòÏÑ∏Ïöî</li>
                        <li>ÌôîÎ©¥Ïóê ÎÇòÌÉÄÎÇòÎäî Í∏ÄÏûêÎ•º ÏùΩÍ≥† Ï†ïÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</li>
                        <li>Ï†êÏ†ê ÏûëÏïÑÏßÄÎäî Í∏ÄÏûêÎ•º ÏùΩÏñ¥Í∞ÄÎ©∞ ÏãúÎ†•ÏùÑ Ï∏°Ï†ïÌï©ÎãàÎã§</li>
                        <li>Í≤ÄÏÇ¨ ÏôÑÎ£å ÌõÑ Í≤∞Í≥ºÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</li>
                    </ol>
                </div>

                <div class="eye-chart" id="eyeChart">
                    <div class="chart-letters" id="chartDisplay">
                        ÏãúÎ†• Í≤ÄÏÇ¨Î•º ÏãúÏûëÌïòÎ†§Î©¥<br>
                        ÏõπÏ∫†ÏùÑ ÌôúÏÑ±ÌôîÌïòÍ≥†<br>
                        'Í≤ÄÏÇ¨ ÏãúÏûë' Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî
                    </div>
                </div>

                <div class="current-test hidden" id="currentTest">
                    <h4>ÌòÑÏû¨ ÎùºÏù∏: <span id="currentLine">1</span>/8</h4>
                    <p>ÌôîÎ©¥Ïùò Í∏ÄÏûêÎ•º ÏùΩÍ≥† ÏïÑÎûòÏóê ÏûÖÎ†•ÌïòÏÑ∏Ïöî:</p>
                    <div class="input-group">
                        <input type="text" id="userInput" placeholder="Î≥¥Ïù¥Îäî Í∏ÄÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="10">
                    </div>
                    <div class="controls">
                        <button id="submitAnswer" class="btn btn-success">Ï†ïÎãµ Ï†úÏ∂ú</button>
                        <button id="cantSee" class="btn btn-danger">Î≥¥Ïù¥ÏßÄ ÏïäÏùå</button>
                        <button id="skipLine" class="btn">Í±¥ÎÑàÎõ∞Í∏∞</button>
                    </div>
                </div>

                <div class="results hidden" id="results">
                    <h3>üéØ Í≤ÄÏÇ¨ Í≤∞Í≥º</h3>
                    <div id="visionResult"></div>
                    <div id="recommendations"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.');
        // document.readyÎ°ú ÌéòÏù¥ÏßÄ Î°úÎìúÎêòÎ©¥ onOpenCvReady Ìò∏Ï∂ú
        // document.addEventListener('DOMContentLoaded', function() {
        //     console.log('DOMÏù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§.');
        //     // OpenCV Î°úÎìú ÌôïÏù∏
        //     console.log('gggggg');
        //     onOpenCvReady();
        //     if (typeof cv !== 'undefined') {
        //     } else {
        //         console.error('OpenCVÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        //         // updateStatus('OpenCV ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î°úÎìúÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'danger');
        //     }
        // });

        // ÏõπÏ∫† ÏãúÏûë Î≤ÑÌäº ÎàÑÎ•¥Î©¥ ÏõπÏ∫† Ìò∏Ï∂ú
        document.getElementById('startWebcam').addEventListener('click', startWebcam);
        // ÏõπÏ∫† Ï§ëÏßÄ Î≤ÑÌäº ÎàÑÎ•¥Î©¥ ÏõπÏ∫† Ï§ëÏßÄ
        document.getElementById('stopWebcam').addEventListener('click', stopWebcam);
        // Í±∞Î¶¨ Î≥¥Ï†ï Î≤ÑÌäº ÎàÑÎ•¥Î©¥ Í±∞Î¶¨ Î≥¥Ï†ï
        document.getElementById('calibrateBtn').addEventListener('click', calibrateDistance);
        // Í≤ÄÏÇ¨ ÏãúÏûë Î≤ÑÌäº ÎàÑÎ•¥Î©¥ ÏãúÎ†• Í≤ÄÏÇ¨ ÏãúÏûë
        document.getElementById('startTestBtn').addEventListener('click', startTest);
        // Ï†ïÎãµ Ï†úÏ∂ú Î≤ÑÌäº ÎàÑÎ•¥Î©¥ Ï†ïÎãµ Ï†úÏ∂ú
        document.getElementById('submitAnswer').addEventListener('click', submitUserAnswer);

        // Ï†ÑÏó≠ Î≥ÄÏàòÎì§
        let webcamStream = null;
        let isWebcamRunning = false;
        let currentDistance = 0;
        let isCalibrated = false;
        let testInProgress = false;
        let currentTestLine = 0;
        let correctAnswers = 0;
        let testResults = [];

        // ÏãúÎ†• Í≤ÄÏÇ¨ Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ (ÏãúÎ†• 0.1Î∂ÄÌÑ∞ 2.0ÍπåÏßÄ)
        const eyeChartData = [
            { line: 1, vision: "0.1", size: 120, letters: "E", description: "Îß§Ïö∞ ÌÅ∞ Í∏ÄÏûê" },
            { line: 2, vision: "0.2", size: 90, letters: "FP", description: "ÌÅ∞ Í∏ÄÏûê" },
            { line: 3, vision: "0.3", size: 70, letters: "TOZ", description: "Ï§ëÍ∞Ñ ÌÅ∞ Í∏ÄÏûê" },
            { line: 4, vision: "0.4", size: 55, letters: "LPED", description: "Ï§ëÍ∞Ñ Í∏ÄÏûê" },
            { line: 5, vision: "0.6", size: 45, letters: "PECFD", description: "ÏûëÏùÄ Í∏ÄÏûê" },
            { line: 6, vision: "0.8", size: 35, letters: "EDFCZP", description: "Îçî ÏûëÏùÄ Í∏ÄÏûê" },
            { line: 7, vision: "1.0", size: 28, letters: "FELOPZD", description: "ÌëúÏ§Ä Í∏ÄÏûê" },
            { line: 8, vision: "1.2", size: 22, letters: "DEFPOTEC", description: "Îß§Ïö∞ ÏûëÏùÄ Í∏ÄÏûê" }
        ];

        // DOM ÏöîÏÜåÎì§
        const webcam = document.getElementById('webcam');
        const overlay = document.getElementById('overlay');
        const startWebcamBtn = document.getElementById('startWebcam');
        const stopWebcamBtn = document.getElementById('stopWebcam');
        const distanceDisplay = document.getElementById('distanceDisplay');
        const calibrateBtn = document.getElementById('calibrateBtn');
        const startTestBtn = document.getElementById('startTestBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressBar = document.getElementById('progressBar');
        const testStatus = document.getElementById('testStatus');
        const eyeChart = document.getElementById('eyeChart');
        const chartDisplay = document.getElementById('chartDisplay');
        const currentTest = document.getElementById('currentTest');
        const currentLine = document.getElementById('currentLine');
        const userInput = document.getElementById('userInput');
        const submitAnswer = document.getElementById('submitAnswer');
        const cantSee = document.getElementById('cantSee');
        const skipLine = document.getElementById('skipLine');
        const results = document.getElementById('results');
        const visionResult = document.getElementById('visionResult');
        const recommendations = document.getElementById('recommendations');

        // OpenCV Ï§ÄÎπÑ ÌôïÏù∏
        function onOpenCvReady() {
            console.log('OpenCVÍ∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§.');
            updateStatus('OpenCV ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏóàÏäµÎãàÎã§.', 'success');
        }

        function updateStatus (message, type) {
            testStatus.textContent = message;
            testStatus.className = `status ${type}`;
        }

        // ÏõπÏ∫† ÏãúÏûë
        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user'
                    } 
                });
                webcam.srcObject = webcamStream;
                isWebcamRunning = true;
                
                startWebcamBtn.disabled = true;
                stopWebcamBtn.disabled = false;
                calibrateBtn.disabled = false;
                
                updateStatus('ÏõπÏ∫†Ïù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. Í±∞Î¶¨ Î≥¥Ï†ïÏùÑ ÏßÑÌñâÌï¥Ï£ºÏÑ∏Ïöî.', 'success');
                
                // ÏñºÍµ¥ Ïù∏Ïãù ÏãúÏûë
                webcam.addEventListener('loadeddata', startFaceDetection);
                
            } catch (error) {
                console.error('ÏõπÏ∫† Ï†ëÍ∑º Ïò§Î•ò:', error);
                updateStatus('ÏõπÏ∫†Ïóê Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§. Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
            }
        }

        // ÏõπÏ∫† Ï§ëÏßÄ
        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }
            isWebcamRunning = false;
            
            startWebcamBtn.disabled = false;
            stopWebcamBtn.disabled = true;
            calibrateBtn.disabled = true;
            startTestBtn.disabled = true;
            
            updateStatus('ÏõπÏ∫†Ïù¥ Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§.', 'info');
        }

        // ÏñºÍµ¥ Ïù∏Ïãù Î∞è Í±∞Î¶¨ Ï∏°Ï†ï
        function startFaceDetection() {
            if (!isWebcamRunning) return;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            function detectFace() {
                if (!isWebcamRunning) return;
                
                canvas.width = webcam.videoWidth;
                canvas.height = webcam.videoHeight;
                ctx.drawImage(webcam, 0, 0);
                
                try {
                    // OpenCVÎ°ú ÏñºÍµ¥ Ïù∏Ïãù (Í∞ÑÎã®Ìïú Î∞©Î≤ï)
                    const src = cv.imread(canvas);
                    const gray = new cv.Mat();
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                    
                    // ÏñºÍµ¥ ÌÅ¨Í∏∞Î•º Í∏∞Î∞òÏúºÎ°ú Í±∞Î¶¨ Ï∂îÏ†ï (Í∑ºÏÇ¨Ïπò)
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const avgBrightness = calculateAverageBrightness(imageData);
                    
                    // Í∞ÑÎã®Ìïú Í±∞Î¶¨ Ï∂îÏ†ï ÏïåÍ≥†Î¶¨Ï¶ò (Ïã§Ï†úÎ°úÎäî Îçî Î≥µÏû°Ìï®)
                    const estimatedDistance = estimateDistance(canvas.width, canvas.height);
                    currentDistance = estimatedDistance;
                    
                    distanceDisplay.textContent = `${Math.round(estimatedDistance)}cm`;
                    
                    // Í±∞Î¶¨Í∞Ä Ï†ÅÏ†àÌïúÏßÄ ÌôïÏù∏
                    const targetDistance = parseInt(document.getElementById('testDistance').value);
                    if (Math.abs(estimatedDistance - targetDistance) < 10) {
                        distanceDisplay.style.color = '#27ae60';
                    } else {
                        distanceDisplay.style.color = '#e74c3c';
                    }
                    
                    src.delete();
                    gray.delete();
                    
                } catch (error) {
                    // OpenCV Ïò§Î•ò Ïãú Í∏∞Î≥∏ Í±∞Î¶¨ Ï∂îÏ†ï
                    const estimatedDistance = 60 + Math.random() * 20 - 10; // 50-70cm Î≤îÏúÑ
                    currentDistance = estimatedDistance;
                    distanceDisplay.textContent = `${Math.round(estimatedDistance)}cm (Ï∂îÏ†ï)`;
                }
                
                setTimeout(detectFace, 100); // 100msÎßàÎã§ Ïã§Ìñâ
            }
            
            detectFace();
        }

        // Í∞ÑÎã®Ìïú Í±∞Î¶¨ Ï∂îÏ†ï Ìï®Ïàò
        function estimateDistance(width, height) {
            // ÏõπÏ∫† Ìï¥ÏÉÅÎèÑÏôÄ ÏùºÎ∞òÏ†ÅÏù∏ ÏñºÍµ¥ ÌÅ¨Í∏∞Î•º Í∏∞Î∞òÏúºÎ°ú Ìïú Ï∂îÏ†ï
            // Ïã§Ï†úÎ°úÎäî Îçî Ï†ïÍµêÌïú ÏïåÍ≥†Î¶¨Ï¶òÏù¥ ÌïÑÏöî
            const baseDistance = 60;
            const variation = Math.random() * 20 - 10; // ¬±10cm Î≥ÄÎèô
            return baseDistance + variation;
        }

        // ÌèâÍ∑† Î∞ùÍ∏∞ Í≥ÑÏÇ∞
        function calculateAverageBrightness(imageData) {
            let total = 0;
            for (let i = 0; i < imageData.data.length; i += 4) {
                const r = imageData.data[i];
                const g = imageData.data[i + 1];
                const b = imageData.data[i + 2];
                total += (r + g + b) / 3;
            }
            return total / (imageData.data.length / 4);
        }

        // Í±∞Î¶¨ Î≥¥Ï†ï
        function calibrateDistance() {
            if (!isWebcamRunning) {
                updateStatus('Î®ºÏ†Ä ÏõπÏ∫†ÏùÑ ÏãúÏûëÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            const targetDistance = parseInt(document.getElementById('testDistance').value);
            updateStatus(`${targetDistance}cm Í±∞Î¶¨ÏóêÏÑú ÌôîÎ©¥ÏùÑ Î≥¥Í≥† ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Î≥¥Ï†ïÏùÑ ÏôÑÎ£åÌï©ÎãàÎã§.`, 'info');
            
            setTimeout(() => {
                isCalibrated = true;
                startTestBtn.disabled = false;
                updateStatus('Í±∞Î¶¨ Î≥¥Ï†ïÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. ÏãúÎ†• Í≤ÄÏÇ¨Î•º ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§.', 'success');
            }, 2000);
        }

        // ÏãúÎ†• Í≤ÄÏÇ¨ ÏãúÏûë
        function startTest() {
            if (!isCalibrated) {
                updateStatus('Î®ºÏ†Ä Í±∞Î¶¨ Î≥¥Ï†ïÏùÑ ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            testInProgress = true;
            currentTestLine = 0;
            correctAnswers = 0;
            testResults = [];
            
            startTestBtn.disabled = true;
            currentTest.classList.remove('hidden');
            results.classList.add('hidden');
            
            showNextLine();
            updateStatus('ÏãúÎ†• Í≤ÄÏÇ¨Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.', 'info');
        }

        // Îã§Ïùå ÎùºÏù∏ ÌëúÏãú
        function showNextLine() {
            if (currentTestLine >= eyeChartData.length) {
                completeTest();
                return;
            }
            
            const lineData = eyeChartData[currentTestLine];
            currentLine.textContent = `${lineData.line}`;
            
            // Ï∞®Ìä∏Ïóê Í∏ÄÏûê ÌëúÏãú
            chartDisplay.innerHTML = `<div style="font-size: ${lineData.size}px; line-height: 1.2;">${lineData.letters}</div>`;
            
            // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
            const progress = ((currentTestLine + 1) / eyeChartData.length) * 100;
            progressBar.style.width = `${progress}%`;
            
            // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            userInput.value = '';
            userInput.focus();
        }

        // ÎãµÏïà Ï†úÏ∂ú
        function submitUserAnswer() {
            const userAnswer = userInput.value.toUpperCase().trim();
            const correctAnswer = eyeChartData[currentTestLine].letters;
            const isCorrect = userAnswer === correctAnswer;
            
            testResults.push({
                line: currentTestLine + 1,
                vision: eyeChartData[currentTestLine].vision,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                canSee: true
            });
            
            if (isCorrect) {
                correctAnswers++;
                updateStatus(`Ï†ïÎãµÏûÖÎãàÎã§! (${correctAnswer})`, 'success');
            } else {
                updateStatus(`ÌãÄÎ†∏ÏäµÎãàÎã§. Ï†ïÎãµ: ${correctAnswer}, ÏûÖÎ†•: ${userAnswer}`, 'warning');
            }
            
            currentTestLine++;
            setTimeout(showNextLine, 1500);
        }

        // Î≥¥Ïù¥ÏßÄ ÏïäÏùå Ï≤òÎ¶¨
        function cantSeeAnswer() {
            testResults.push({
                line: currentTestLine + 1,
                vision: eyeChartData[currentTestLine].vision,
                userAnswer: '',
                correctAnswer: eyeChartData[currentTestLine].letters,
                isCorrect: false,
                canSee: false
            });
            
            updateStatus('Ìï¥Îãπ ÎùºÏù∏ÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÎã§Í≥† Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§.', 'info');
            
            // Ïó∞ÏÜçÏúºÎ°ú 2Í∞úÎ•º Î™ª Î≥¥Î©¥ Í≤ÄÏÇ¨ Ï¢ÖÎ£å
            if (currentTestLine > 0 && !testResults[currentTestLine - 1].canSee) {
                completeTest();
                return;
            }
            
            currentTestLine++;
            setTimeout(showNextLine, 1000);
        }

        // ÎùºÏù∏ Í±¥ÎÑàÎõ∞Í∏∞
        function skipCurrentLine() {
            testResults.push({
                line: currentTestLine + 1,
                vision: eyeChartData[currentTestLine].vision,
                userAnswer: 'SKIP',
                correctAnswer: eyeChartData[currentTestLine].letters,
                isCorrect: false,
                canSee: true
            });
            
            currentTestLine++;
            setTimeout(showNextLine, 500);
        }

        // Í≤ÄÏÇ¨ ÏôÑÎ£å
        function completeTest() {
            testInProgress = false;
            currentTest.classList.add('hidden');
            results.classList.remove('hidden');
            startTestBtn.disabled = false;
            
            // Í≤∞Í≥º Î∂ÑÏÑù
            analyzeResults();
            updateStatus('ÏãúÎ†• Í≤ÄÏÇ¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.', 'success');
        }

        // Í≤∞Í≥º Î∂ÑÏÑù
        function analyzeResults() {
            let lastCorrectVision = "0.1";
            let estimatedVision = "0.1";
            
            // ÎßàÏßÄÎßâÏúºÎ°ú Ï†ïÌôïÌûà ÏùΩÏùÄ ÎùºÏù∏ Ï∞æÍ∏∞
            for (let i = testResults.length - 1; i >= 0; i--) {
                if (testResults[i].isCorrect) {
                    lastCorrectVision = testResults[i].vision;
                    estimatedVision = testResults[i].vision;
                    break;
                }
            }
            
            // Î∂ÄÎ∂ÑÏ†ÅÏúºÎ°ú ÏùΩÏùÄ ÎùºÏù∏ Í≥†Î†§
            let partialCredit = 0;
            for (let result of testResults) {
                if (!result.isCorrect && result.canSee && result.userAnswer !== 'SKIP') {
                    // Î∂ÄÎ∂Ñ Ï†êÏàò Í≥ÑÏÇ∞
                    const similarity = calculateSimilarity(result.userAnswer, result.correctAnswer);
                    if (similarity > 0.5) {
                        partialCredit += 0.1;
                    }
                }
            }
            
            const finalVision = parseFloat(estimatedVision) + partialCredit;
            
            // Í≤∞Í≥º ÌëúÏãú
            let resultHTML = `
                <h4>üìä Ï∏°Ï†ïÎêú ÏãúÎ†•: ${finalVision.toFixed(1)}</h4>
                <p><strong>Ï†ïÌôïÌûà ÏùΩÏùÄ ÎßàÏßÄÎßâ ÎùºÏù∏:</strong> ${lastCorrectVision}</p>
                <p><strong>Ï¥ù Ï†ïÎãµÎ•†:</strong> ${Math.round((correctAnswers / testResults.length) * 100)}%</p>
                <p><strong>Í≤ÄÏÇ¨Ìïú Îàà:</strong> ${document.getElementById('testEye').value === 'both' ? 'ÏñëÏ™Ω Îàà' : document.getElementById('testEye').value === 'left' ? 'ÏôºÏ™Ω Îàà' : 'Ïò§Î•∏Ï™Ω Îàà'}</p>
            `;
            
            visionResult.innerHTML = resultHTML;
            
            // Í∂åÏû•ÏÇ¨Ìï≠
            let recommendationHTML = '<h4>üí° Í∂åÏû•ÏÇ¨Ìï≠</h4>';
            if (finalVision >= 1.0) {
                recommendationHTML += '<p style="color: #27ae60;">‚úÖ Ï†ïÏÉÅ ÏãúÎ†•ÏûÖÎãàÎã§. Ï†ïÍ∏∞Ï†ÅÏù∏ ÏãúÎ†• Í≤ÄÏÇ¨Î•º Í∂åÏû•Ìï©ÎãàÎã§.</p>';
            } else if (finalVision >= 0.7) {
                recommendationHTML += '<p style="color: #f39c12;">‚ö†Ô∏è Í≤ΩÎØ∏Ìïú ÏãúÎ†• Ï†ÄÌïòÍ∞Ä ÏûàÏùÑ Ïàò ÏûàÏäµÎãàÎã§. ÏïàÍ≥º Í≤ÄÏßÑÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.</p>';
            } else if (finalVision >= 0.4 ) {
                recommendationHTML += '<p style="color: #e67e22;">‚ö†Ô∏è ÏãúÎ†• Ï†ÄÌïòÍ∞Ä ÏûàÏäµÎãàÎã§. ÏïàÍ≥º Í≤ÄÏßÑÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.</p>';
            } else {
                recommendationHTML += '<p style="color: #e74c3c;">‚ùó Ïã¨Í∞ÅÌïú ÏãúÎ†• Ï†ÄÌïòÍ∞Ä ÏûàÏäµÎãàÎã§. Ï¶âÏãú ÏïàÍ≥º Í≤ÄÏßÑÏùÑ Î∞õÏúºÏÑ∏Ïöî.</p>';
            }
        }
    </script>
