<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì‹œë ¥ ê²€ì‚¬ ë„êµ¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/opencv.js/4.5.5/opencv.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            color: #7f8c8d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .test-area {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.3em;
        }

        .video-container {
            position: relative;
            margin-bottom: 20px;
        }

        #webcam {
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            border: 3px solid #3498db;
        }

        .distance-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .eye-chart {
            background: white;
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #ecf0f1;
            margin: 20px 0;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-line {
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 3px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .test-progress {
            background: #ecf0f1;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }

        .results {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
        }

        .calibration {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .instructions {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
        }

        .instructions h4 {
            color: #27ae60;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }

        .hidden {
            display: none;
        }

        .chart-letters {
            font-size: 60px;
            line-height: 1.2;
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 10px;
        }

        .current-test {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .face-detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘ï¸ AI ì‹œë ¥ ê²€ì‚¬ ë„êµ¬</h1>
            <p>ì›¹ìº ê³¼ AIë¥¼ í™œìš©í•œ ìê°€ ì‹œë ¥ ê²€ì‚¬ ì‹œìŠ¤í…œ</p>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <div class="section">
                    <h3>ğŸ“¹ ì›¹ìº  ì„¤ì •</h3>
                    <div class="video-container">
                        <video id="webcam" autoplay muted></video>
                        <canvas id="overlay" class="face-detection-overlay"></canvas>
                    </div>
                    <button id="startWebcam" class="btn">ì›¹ìº  ì‹œì‘</button>
                    <button id="stopWebcam" class="btn btn-danger">ì›¹ìº  ì¤‘ì§€</button>
                    <div class="distance-info">
                        <strong>ì¸¡ì •ëœ ê±°ë¦¬:</strong> <span id="distanceDisplay">ì¸¡ì • ì¤‘...</span><br>
                        <strong>ê¶Œì¥ ê±°ë¦¬:</strong> 60cm
                    </div>
                </div>

                <div class="section">
                    <h3>âš™ï¸ ê²€ì‚¬ ì„¤ì •</h3>
                    <div class="input-group">
                        <label for="testEye">ê²€ì‚¬í•  ëˆˆ:</label>
                        <select id="testEye">
                            <option value="both">ì–‘ìª½ ëˆˆ</option>
                            <option value="left">ì™¼ìª½ ëˆˆ</option>
                            <option value="right">ì˜¤ë¥¸ìª½ ëˆˆ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="screenSize">ëª¨ë‹ˆí„° í¬ê¸° (ì¸ì¹˜):</label>
                        <input type="number" id="screenSize" value="24" min="10" max="50" step="0.1">
                    </div>
                    <div class="input-group">
                        <label for="testDistance">ê²€ì‚¬ ê±°ë¦¬ (cm):</label>
                        <input type="number" id="testDistance" value="60" min="30" max="100" step="5">
                    </div>
                </div>

                <div class="section">
                    <h3>ğŸ¯ ê²€ì‚¬ ì œì–´</h3>
                    <button id="calibrateBtn" class="btn">ê±°ë¦¬ ë³´ì •</button>
                    <button id="startTestBtn" class="btn btn-success" disabled>ê²€ì‚¬ ì‹œì‘</button>
                    <button id="resetBtn" class="btn btn-danger">ì´ˆê¸°í™”</button>
                    
                    <div class="test-progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div id="testStatus" class="status info">ì›¹ìº ì„ ì‹œì‘í•˜ê³  ê±°ë¦¬ë¥¼ ë³´ì •í•´ì£¼ì„¸ìš”.</div>
                </div>
            </div>

            <div class="test-area">
                <div class="instructions">
                    <h4>ğŸ“‹ ê²€ì‚¬ ë°©ë²•</h4>
                    <ol>
                        <li>ì›¹ìº ì„ ì‹œì‘í•˜ê³  í™”ë©´ì—ì„œ 60cm ê±°ë¦¬ë¥¼ ìœ ì§€í•˜ì„¸ìš”</li>
                        <li>í•œìª½ ëˆˆì„ ê°€ë¦¬ê³  ê²€ì‚¬í•˜ê±°ë‚˜ ì–‘ìª½ ëˆˆìœ¼ë¡œ ê²€ì‚¬í•˜ì„¸ìš”</li>
                        <li>í™”ë©´ì— ë‚˜íƒ€ë‚˜ëŠ” ê¸€ìë¥¼ ì½ê³  ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”</li>
                        <li>ì ì  ì‘ì•„ì§€ëŠ” ê¸€ìë¥¼ ì½ì–´ê°€ë©° ì‹œë ¥ì„ ì¸¡ì •í•©ë‹ˆë‹¤</li>
                        <li>ê²€ì‚¬ ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</li>
                    </ol>
                </div>

                <div class="eye-chart" id="eyeChart">
                    <div class="chart-letters" id="chartDisplay">
                        ì‹œë ¥ ê²€ì‚¬ë¥¼ ì‹œì‘í•˜ë ¤ë©´<br>
                        ì›¹ìº ì„ í™œì„±í™”í•˜ê³ <br>
                        'ê²€ì‚¬ ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
                    </div>
                </div>

                <div class="current-test hidden" id="currentTest">
                    <h4>í˜„ì¬ ë¼ì¸: <span id="currentLine">1</span>/8</h4>
                    <p>í™”ë©´ì˜ ê¸€ìë¥¼ ì½ê³  ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”:</p>
                    <div class="input-group">
                        <input type="text" id="userInput" placeholder="ë³´ì´ëŠ” ê¸€ìë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
                    </div>
                    <div class="controls">
                        <button id="submitAnswer" class="btn btn-success">ì •ë‹µ ì œì¶œ</button>
                        <button id="cantSee" class="btn btn-danger">ë³´ì´ì§€ ì•ŠìŒ</button>
                        <button id="skipLine" class="btn">ê±´ë„ˆë›°ê¸°</button>
                    </div>
                </div>

                <div class="results hidden" id="results">
                    <h3>ğŸ¯ ê²€ì‚¬ ê²°ê³¼</h3>
                    <div id="visionResult"></div>
                    <div id="recommendations"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // document.readyë¡œ í˜ì´ì§€ ë¡œë“œë˜ë©´ onOpenCvReady í˜¸ì¶œ
        // document.addEventListener('DOMContentLoaded', function() {
        //     console.log('DOMì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        //     // OpenCV ë¡œë“œ í™•ì¸
        //     console.log('gggggg');
        //     onOpenCvReady();
        //     if (typeof cv !== 'undefined') {
        //     } else {
        //         console.error('OpenCVê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        //         // updateStatus('OpenCV ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
        //     }
        // });

        // ì›¹ìº  ì‹œì‘ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì›¹ìº  í˜¸ì¶œ
        document.getElementById('startWebcam').addEventListener('click', startWebcam);
        // ì›¹ìº  ì¤‘ì§€ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì›¹ìº  ì¤‘ì§€
        document.getElementById('stopWebcam').addEventListener('click', stopWebcam);
        // ê±°ë¦¬ ë³´ì • ë²„íŠ¼ ëˆ„ë¥´ë©´ ê±°ë¦¬ ë³´ì •
        document.getElementById('calibrateBtn').addEventListener('click', calibrateDistance);
        // ê²€ì‚¬ ì‹œì‘ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì‹œë ¥ ê²€ì‚¬ ì‹œì‘
        document.getElementById('startTestBtn').addEventListener('click', startTest);
        // ì •ë‹µ ì œì¶œ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì •ë‹µ ì œì¶œ
        document.getElementById('submitAnswer').addEventListener('click', submitUserAnswer);

        // ì „ì—­ ë³€ìˆ˜ë“¤
        let webcamStream = null;
        let isWebcamRunning = false;
        let currentDistance = 0;
        let isCalibrated = false;
        let testInProgress = false;
        let currentTestLine = 0;
        let correctAnswers = 0;
        let testResults = [];

        // ì‹œë ¥ ê²€ì‚¬ ì°¨íŠ¸ ë°ì´í„° (ì‹œë ¥ 0.1ë¶€í„° 2.0ê¹Œì§€)
        const eyeChartData = [
            { line: 1, vision: "0.1", size: 120, letters: "E", description: "ë§¤ìš° í° ê¸€ì" },
            { line: 2, vision: "0.2", size: 90, letters: "FP", description: "í° ê¸€ì" },
            { line: 3, vision: "0.3", size: 70, letters: "TOZ", description: "ì¤‘ê°„ í° ê¸€ì" },
            { line: 4, vision: "0.4", size: 55, letters: "LPED", description: "ì¤‘ê°„ ê¸€ì" },
            { line: 5, vision: "0.6", size: 45, letters: "PECFD", description: "ì‘ì€ ê¸€ì" },
            { line: 6, vision: "0.8", size: 35, letters: "EDFCZP", description: "ë” ì‘ì€ ê¸€ì" },
            { line: 7, vision: "1.0", size: 28, letters: "FELOPZD", description: "í‘œì¤€ ê¸€ì" },
            { line: 8, vision: "1.2", size: 22, letters: "DEFPOTEC", description: "ë§¤ìš° ì‘ì€ ê¸€ì" }
        ];

        // DOM ìš”ì†Œë“¤
        const webcam = document.getElementById('webcam');
        const overlay = document.getElementById('overlay');
        const startWebcamBtn = document.getElementById('startWebcam');
        const stopWebcamBtn = document.getElementById('stopWebcam');
        const distanceDisplay = document.getElementById('distanceDisplay');
        const calibrateBtn = document.getElementById('calibrateBtn');
        const startTestBtn = document.getElementById('startTestBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressBar = document.getElementById('progressBar');
        const testStatus = document.getElementById('testStatus');
        const eyeChart = document.getElementById('eyeChart');
        const chartDisplay = document.getElementById('chartDisplay');
        const currentTest = document.getElementById('currentTest');
        const currentLine = document.getElementById('currentLine');
        const userInput = document.getElementById('userInput');
        const submitAnswer = document.getElementById('submitAnswer');
        const cantSee = document.getElementById('cantSee');
        const skipLine = document.getElementById('skipLine');
        const results = document.getElementById('results');
        const visionResult = document.getElementById('visionResult');
        const recommendations = document.getElementById('recommendations');

        // OpenCV ì¤€ë¹„ í™•ì¸
        function onOpenCvReady() {
            console.log('OpenCVê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
            updateStatus('OpenCV ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function updateStatus (message, type) {
            testStatus.textContent = message;
            testStatus.className = `status ${type}`;
        }

        // ì›¹ìº  ì‹œì‘
        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user'
                    } 
                });
                webcam.srcObject = webcamStream;
                isWebcamRunning = true;
                
                startWebcamBtn.disabled = true;
                stopWebcamBtn.disabled = false;
                calibrateBtn.disabled = false;
                
                updateStatus('ì›¹ìº ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ê±°ë¦¬ ë³´ì •ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.', 'success');
                
                // ì–¼êµ´ ì¸ì‹ ì‹œì‘
                webcam.addEventListener('loadeddata', startFaceDetection);
                
            } catch (error) {
                console.error('ì›¹ìº  ì ‘ê·¼ ì˜¤ë¥˜:', error);
                updateStatus('ì›¹ìº ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'warning');
            }
        }

        // ì›¹ìº  ì¤‘ì§€
        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }
            isWebcamRunning = false;
            
            startWebcamBtn.disabled = false;
            stopWebcamBtn.disabled = true;
            calibrateBtn.disabled = true;
            startTestBtn.disabled = true;
            
            updateStatus('ì›¹ìº ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        // ì–¼êµ´ ì¸ì‹ ë° ê±°ë¦¬ ì¸¡ì •
        function startFaceDetection() {
            if (!isWebcamRunning) return;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            function detectFace() {
                if (!isWebcamRunning) return;
                
                canvas.width = webcam.videoWidth;
                canvas.height = webcam.videoHeight;
                ctx.drawImage(webcam, 0, 0);
                
                try {
                    // OpenCVë¡œ ì–¼êµ´ ì¸ì‹ (ê°„ë‹¨í•œ ë°©ë²•)
                    const src = cv.imread(canvas);
                    const gray = new cv.Mat();
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                    
                    // ì–¼êµ´ í¬ê¸°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê±°ë¦¬ ì¶”ì • (ê·¼ì‚¬ì¹˜)
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const avgBrightness = calculateAverageBrightness(imageData);
                    
                    // ê°„ë‹¨í•œ ê±°ë¦¬ ì¶”ì • ì•Œê³ ë¦¬ì¦˜ (ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•¨)
                    const estimatedDistance = estimateDistance(canvas.width, canvas.height);
                    currentDistance = estimatedDistance;
                    
                    distanceDisplay.textContent = `${Math.round(estimatedDistance)}cm`;
                    
                    // ê±°ë¦¬ê°€ ì ì ˆí•œì§€ í™•ì¸
                    const targetDistance = parseInt(document.getElementById('testDistance').value);
                    if (Math.abs(estimatedDistance - targetDistance) < 10) {
                        distanceDisplay.style.color = '#27ae60';
                    } else {
                        distanceDisplay.style.color = '#e74c3c';
                    }
                    
                    src.delete();
                    gray.delete();
                    
                } catch (error) {
                    // OpenCV ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ê±°ë¦¬ ì¶”ì •
                    const estimatedDistance = 60 + Math.random() * 20 - 10; // 50-70cm ë²”ìœ„
                    currentDistance = estimatedDistance;
                    distanceDisplay.textContent = `${Math.round(estimatedDistance)}cm (ì¶”ì •)`;
                }
                
                setTimeout(detectFace, 100); // 100msë§ˆë‹¤ ì‹¤í–‰
            }
            
            detectFace();
        }

        // ê°„ë‹¨í•œ ê±°ë¦¬ ì¶”ì • í•¨ìˆ˜
        function estimateDistance(width, height) {
            // ì›¹ìº  í•´ìƒë„ì™€ ì¼ë°˜ì ì¸ ì–¼êµ´ í¬ê¸°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì¶”ì •
            // ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ ì•Œê³ ë¦¬ì¦˜ì´ í•„ìš”
            const baseDistance = 60;
            const variation = Math.random() * 20 - 10; // Â±10cm ë³€ë™
            return baseDistance + variation;
        }

        // í‰ê·  ë°ê¸° ê³„ì‚°
        function calculateAverageBrightness(imageData) {
            let total = 0;
            for (let i = 0; i < imageData.data.length; i += 4) {
                const r = imageData.data[i];
                const g = imageData.data[i + 1];
                const b = imageData.data[i + 2];
                total += (r + g + b) / 3;
            }
            return total / (imageData.data.length / 4);
        }

        // ê±°ë¦¬ ë³´ì •
        function calibrateDistance() {
            if (!isWebcamRunning) {
                updateStatus('ë¨¼ì € ì›¹ìº ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const targetDistance = parseInt(document.getElementById('testDistance').value);
            updateStatus(`${targetDistance}cm ê±°ë¦¬ì—ì„œ í™”ë©´ì„ ë³´ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë³´ì •ì„ ì™„ë£Œí•©ë‹ˆë‹¤.`, 'info');
            
            setTimeout(() => {
                isCalibrated = true;
                startTestBtn.disabled = false;
                updateStatus('ê±°ë¦¬ ë³´ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‹œë ¥ ê²€ì‚¬ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
            }, 2000);
        }

        // ì‹œë ¥ ê²€ì‚¬ ì‹œì‘
        function startTest() {
            if (!isCalibrated) {
                updateStatus('ë¨¼ì € ê±°ë¦¬ ë³´ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            testInProgress = true;
            currentTestLine = 0;
            correctAnswers = 0;
            testResults = [];
            
            startTestBtn.disabled = true;
            currentTest.classList.remove('hidden');
            results.classList.add('hidden');
            
            showNextLine();
            updateStatus('ì‹œë ¥ ê²€ì‚¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        // ë‹¤ìŒ ë¼ì¸ í‘œì‹œ
        function showNextLine() {
            if (currentTestLine >= eyeChartData.length) {
                completeTest();
                return;
            }
            
            const lineData = eyeChartData[currentTestLine];
            currentLine.textContent = `${lineData.line}`;
            
            // ì°¨íŠ¸ì— ê¸€ì í‘œì‹œ
            chartDisplay.innerHTML = `<div style="font-size: ${lineData.size}px; line-height: 1.2;">${lineData.letters}</div>`;
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            const progress = ((currentTestLine + 1) / eyeChartData.length) * 100;
            progressBar.style.width = `${progress}%`;
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            userInput.value = '';
            userInput.focus();
        }

        // ë‹µì•ˆ ì œì¶œ
        function submitUserAnswer() {
            const userAnswer = userInput.value.toUpperCase().trim();
            const correctAnswer = eyeChartData[currentTestLine].letters;
            const isCorrect = userAnswer === correctAnswer;
            
            testResults.push({
                line: currentTestLine + 1,
                vision: eyeChartData[currentTestLine].vision,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                canSee: true
            });
            
            if (isCorrect) {
                correctAnswers++;
                updateStatus(`ì •ë‹µì…ë‹ˆë‹¤! (${correctAnswer})`, 'success');
            } else {
                updateStatus(`í‹€ë ¸ìŠµë‹ˆë‹¤. ì •ë‹µ: ${correctAnswer}, ì…ë ¥: ${userAnswer}`, 'warning');
            }
            
            currentTestLine++;
            setTimeout(showNextLine, 1500);
        }

        // ë³´ì´ì§€ ì•ŠìŒ ì²˜ë¦¬
        function cantSeeAnswer() {
            testResults.push({
                line: currentTestLine + 1,
                vision: eyeChartData[currentTestLine].vision,
                userAnswer: '',
                correctAnswer: eyeChartData[currentTestLine].letters,
                isCorrect: false,
                canSee: false
            });
            
            updateStatus('í•´ë‹¹ ë¼ì¸ì„ ì½ì„ ìˆ˜ ì—†ë‹¤ê³  ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            
            // ì—°ì†ìœ¼ë¡œ 2ê°œë¥¼ ëª» ë³´ë©´ ê²€ì‚¬ ì¢…ë£Œ
            if (currentTestLine > 0 && !testResults[currentTestLine - 1].canSee) {
                completeTest();
                return;
            }
            
            currentTestLine++;
            setTimeout(showNextLine, 1000);
        }

        // ë¼ì¸ ê±´ë„ˆë›°ê¸°
        function skipCurrentLine() {
            testResults.push({
                line: currentTestLine + 1,
                vision: eyeChartData[currentTestLine].vision,
                userAnswer: 'SKIP',
                correctAnswer: eyeChartData[currentTestLine].letters,
                isCorrect: false,
                canSee: true
            });
            
            currentTestLine++;
            setTimeout(showNextLine, 500);
        }

        // ê²€ì‚¬ ì™„ë£Œ
        function completeTest() {
            testInProgress = false;
            currentTest.classList.add('hidden');
            results.classList.remove('hidden');
            startTestBtn.disabled = false;
            
            // ê²°ê³¼ ë¶„ì„
            analyzeResults();
            updateStatus('ì‹œë ¥ ê²€ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ê²°ê³¼ ë¶„ì„
        function analyzeResults() {
            let lastCorrectVision = "0.1";
            let estimatedVision = "0.1";
            
            // ë§ˆì§€ë§‰ìœ¼ë¡œ ì •í™•íˆ ì½ì€ ë¼ì¸ ì°¾ê¸°
            for (let i = testResults.length - 1; i >= 0; i--) {
                if (testResults[i].isCorrect) {
                    lastCorrectVision = testResults[i].vision;
                    estimatedVision = testResults[i].vision;
                    break;
                }
            }
            
            // ë¶€ë¶„ì ìœ¼ë¡œ ì½ì€ ë¼ì¸ ê³ ë ¤
            let partialCredit = 0;
            for (let result of testResults) {
                if (!result.isCorrect && result.canSee && result.userAnswer !== 'SKIP') {
                    // ë¶€ë¶„ ì ìˆ˜ ê³„ì‚°
                    const similarity = calculateSimilarity(result.userAnswer, result.correctAnswer);
                    if (similarity > 0.5) {
                        partialCredit += 0.1;
                    }
                }
            }
            
            const finalVision = parseFloat(estimatedVision) + partialCredit;
            
            // ê²°ê³¼ í‘œì‹œ
            let resultHTML = `
                <h4>ğŸ“Š ì¸¡ì •ëœ ì‹œë ¥: ${finalVision.toFixed(1)}</h4>
                <p><strong>ì •í™•íˆ ì½ì€ ë§ˆì§€ë§‰ ë¼ì¸:</strong> ${lastCorrectVision}</p>
                <p><strong>ì´ ì •ë‹µë¥ :</strong> ${Math.round((correctAnswers / testResults.length) * 100)}%</p>
                <p><strong>ê²€ì‚¬í•œ ëˆˆ:</strong> ${document.getElementById('testEye').value === 'both' ? 'ì–‘ìª½ ëˆˆ' : document.getElementById('testEye').value === 'left' ? 'ì™¼ìª½ ëˆˆ' : 'ì˜¤ë¥¸ìª½ ëˆˆ'}</p>
            `;
            
            visionResult.innerHTML = resultHTML;
            
            // ê¶Œì¥ì‚¬í•­
            let recommendationHTML = '<h4>ğŸ’¡ ê¶Œì¥ì‚¬í•­</h4>';
            if (finalVision >= 1.0) {
                recommendationHTML += '<p style="color: #27ae60;">âœ… ì •ìƒ ì‹œë ¥ì…ë‹ˆë‹¤. ì •ê¸°ì ì¸ ì‹œë ¥ ê²€ì‚¬ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</p>';
            } else if (finalVision >= 0.7) {
                recommendationHTML += '<p style="color: #f39c12;">âš ï¸ ê²½ë¯¸í•œ ì‹œë ¥ ì €í•˜ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•ˆê³¼ ê²€ì§„ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>';
            } else if (finalVision >= 0.4 ) {
                recommendationHTML += '<p style="color: #e67e22;">âš ï¸ ì‹œë ¥ ì €í•˜ê°€ ìˆìŠµë‹ˆë‹¤. ì•ˆê³¼ ê²€ì§„ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>';
            } else {
                recommendationHTML += '<p style="color: #e74c3c;">â— ì‹¬ê°í•œ ì‹œë ¥ ì €í•˜ê°€ ìˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ ì•ˆê³¼ ê²€ì§„ì„ ë°›ìœ¼ì„¸ìš”.</p>';
            }
        }
    </script>
